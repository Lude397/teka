<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teka - Mes Commandes</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #1A1A2E;
            --light: #FAFAFA;
            --gray: #6B7280;
            --gray-light: #E5E7EB;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --white: #FFFFFF;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--light); color: var(--secondary); line-height: 1.5; min-height: 100vh; padding-bottom: 80px; }
        
        .header { background: var(--white); padding: 16px 20px; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .back-btn { width: 40px; height: 40px; background: var(--light); border: none; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--secondary); }
        .header-title { font-size: 18px; font-weight: 600; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px 16px; }

        .stats-bar { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; }
        .stat-chip { background: var(--white); padding: 8px 16px; border-radius: 20px; font-size: 13px; white-space: nowrap; box-shadow: var(--shadow); }
        .stat-chip strong { color: var(--primary); }

        .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; }
        .filter-tab { padding: 8px 16px; border: 2px solid var(--gray-light); background: var(--white); border-radius: 20px; font-family: inherit; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .filter-tab:hover { border-color: var(--primary); }
        .filter-tab.active { background: var(--primary); border-color: var(--primary); color: var(--white); }

        .orders-list { display: flex; flex-direction: column; gap: 12px; }
        .order-card { background: var(--white); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .order-id { font-size: 12px; color: var(--gray); }
        .order-status { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .order-status.pending { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .order-status.confirmed { background: rgba(59, 130, 246, 0.1); color: #3B82F6; }
        .order-status.shipped { background: rgba(139, 92, 246, 0.1); color: #8B5CF6; }
        .order-status.delivered { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .order-status.cancelled { background: rgba(239, 68, 68, 0.1); color: var(--error); }

        .order-product { display: flex; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--gray-light); }
        .order-product-image { width: 60px; height: 60px; background: var(--gray-light); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 24px; overflow: hidden; }
        .order-product-image img { width: 100%; height: 100%; object-fit: cover; }
        .order-product-info { flex: 1; }
        .order-product-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .order-product-details { font-size: 12px; color: var(--gray); }
        .order-product-price { font-size: 16px; font-weight: 700; color: var(--primary); }

        .order-customer { margin-bottom: 12px; }
        .order-customer-name { font-size: 14px; font-weight: 600; }
        .order-customer-details { font-size: 12px; color: var(--gray); }

        .order-footer { display: flex; justify-content: space-between; align-items: center; }
        .order-total { font-size: 14px; }
        .order-total strong { color: var(--primary); font-size: 16px; }
        .order-date { font-size: 11px; color: var(--gray); }

        .order-actions { display: flex; gap: 8px; margin-top: 12px; }
        .order-action-btn { flex: 1; padding: 10px; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .order-action-btn.primary { background: var(--primary); color: var(--white); }
        .order-action-btn.secondary { background: var(--light); color: var(--secondary); }
        .order-action-btn.danger { background: rgba(239, 68, 68, 0.1); color: var(--error); }

        .empty-state { text-align: center; padding: 60px 20px; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-state-text { font-size: 14px; color: var(--gray); }
        .loading { text-align: center; padding: 40px; color: var(--gray); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; z-index: 100; }
        .nav-item { flex: 1; padding: 12px 8px; text-align: center; text-decoration: none; color: var(--gray); font-size: 10px; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .nav-label { font-weight: 500; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--white); border-radius: var(--radius); padding: 24px; max-width: 400px; width: 100%; }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
        .modal-text { font-size: 14px; color: var(--gray); margin-bottom: 20px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn.cancel { background: var(--light); color: var(--secondary); }

        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            .orders-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .bottom-nav { display: none; }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="Dashboard.html" class="back-btn">‚Üê</a>
                <span class="header-title">Mes Commandes</span>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="stats-bar">
            <div class="stat-chip"><strong id="totalOrders">0</strong> commandes</div>
            <div class="stat-chip"><strong id="pendingOrders">0</strong> en attente</div>
            <div class="stat-chip"><strong id="totalRevenue">0</strong> FCFA</div>
        </div>

        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterOrders('all')">Toutes</button>
            <button class="filter-tab" onclick="filterOrders('pending')">En attente</button>
            <button class="filter-tab" onclick="filterOrders('confirmed')">Confirmees</button>
            <button class="filter-tab" onclick="filterOrders('shipped')">Expediees</button>
            <button class="filter-tab" onclick="filterOrders('delivered')">Livrees</button>
            <button class="filter-tab" onclick="filterOrders('cancelled')">Annulees</button>
        </div>

        <div class="orders-list" id="ordersList">
            <div class="loading">Chargement...</div>
        </div>
    </main>

    <div class="modal-overlay" id="statusModal">
        <div class="modal-content">
            <h3 class="modal-title">Changer le statut</h3>
            <p class="modal-text">Selectionne le nouveau statut :</p>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                <button class="order-action-btn secondary" onclick="updateStatus('confirmed')">Confirmer</button>
                <button class="order-action-btn secondary" onclick="updateStatus('shipped')">Expediee</button>
                <button class="order-action-btn secondary" onclick="updateStatus('delivered')">Livree</button>
                <button class="order-action-btn danger" onclick="updateStatus('cancelled')">Annuler</button>
            </div>
            <button class="modal-btn cancel" onclick="closeStatusModal()" style="width: 100%;">Fermer</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="Dashboard.html" class="nav-item"><div class="nav-icon">üè†</div><div class="nav-label">Accueil</div></a>
        <a href="produits.html" class="nav-item"><div class="nav-icon">üì¶</div><div class="nav-label">Produits</div></a>
        <a href="commande.html" class="nav-item active"><div class="nav-icon">üßæ</div><div class="nav-label">Commandes</div></a>
        <a href="conversation.html" class="nav-item"><div class="nav-icon">üí¨</div><div class="nav-label">Messages</div></a>
        <a href="trafic.html" class="nav-item"><div class="nav-icon">üìä</div><div class="nav-label">Trafic</div></a>
    </nav>

    <script>
        var SUPABASE_URL = 'https://kolwacpvfxdrptldipzj.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvbHdhY3B2ZnhkcnB0bGRpcHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MjYzOTMsImV4cCI6MjA3NzQwMjM5M30.cXXOxBkX9KaddhfY5JoAvMGz-ohxdCoh5iQlHMUGHqE';
        var supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        var vendor = null;
        var orders = [];
        var products = {};
        var currentFilter = 'all';
        var selectedOrderId = null;

        async function init() {
            var vendorData = localStorage.getItem('vendor');
            if (!vendorData) {
                window.location.href = 'login.html';
                return;
            }
            vendor = JSON.parse(vendorData);
            await loadProducts();
            await loadOrders();
        }

        async function loadProducts() {
            var result = await supabaseClient.from('teka_products').select('*').eq('vendor_id', vendor.id);
            if (result.data) {
                result.data.forEach(function(p) { products[p.id] = p; });
            }
        }

        async function loadOrders() {
            var result = await supabaseClient.from('teka_orders').select('*').eq('vendor_id', vendor.id).order('created_at', { ascending: false });
            if (result.error) { console.log('Erreur:', result.error); return; }
            orders = result.data || [];
            updateStats();
            renderOrders();
        }

        function updateStats() {
            var total = orders.length;
            var pending = orders.filter(function(o) { return o.status === 'pending'; }).length;
            var revenue = orders.filter(function(o) { return o.status === 'delivered'; }).reduce(function(sum, o) { return sum + (o.total || 0); }, 0);
            document.getElementById('totalOrders').textContent = total;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('totalRevenue').textContent = formatPrice(revenue);
        }

        function formatPrice(price) { return price.toLocaleString('fr-FR'); }
        function formatDate(dateStr) {
            var date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        function getStatusLabel(status) {
            var labels = { 'pending': 'En attente', 'confirmed': 'Confirmee', 'shipped': 'Expediee', 'delivered': 'Livree', 'cancelled': 'Annulee' };
            return labels[status] || status;
        }

        function filterOrders(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(function(tab) { tab.classList.remove('active'); });
            event.target.classList.add('active');
            renderOrders();
        }

        function renderOrders() {
            var list = document.getElementById('ordersList');
            var filteredOrders = orders;
            if (currentFilter !== 'all') {
                filteredOrders = orders.filter(function(o) { return o.status === currentFilter; });
            }
            if (filteredOrders.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üßæ</div><h3 class="empty-state-title">Aucune commande</h3><p class="empty-state-text">Les commandes de tes clients apparaitront ici</p></div>';
                return;
            }
            var html = '';
            filteredOrders.forEach(function(order) {
                var product = products[order.product_id] || {};
                var productImage = product.images && product.images.length > 0 ? '<img src="' + product.images[0] + '" alt="">' : 'üì¶';
                html += '<div class="order-card"><div class="order-header"><span class="order-id">#' + order.id.slice(0, 8) + '</span><span class="order-status ' + order.status + '">' + getStatusLabel(order.status) + '</span></div><div class="order-product"><div class="order-product-image">' + productImage + '</div><div class="order-product-info"><div class="order-product-name">' + (product.name || 'Produit supprime') + '</div><div class="order-product-details">' + (order.size ? 'Taille: ' + order.size + ' - ' : '') + (order.color ? 'Couleur: ' + order.color + ' - ' : '') + 'Qte: ' + (order.quantity || 1) + '</div></div><div class="order-product-price">' + formatPrice(order.price || 0) + '</div></div><div class="order-customer"><div class="order-customer-name">Client: ' + (order.customer_name || 'Non renseigne') + '</div><div class="order-customer-details">Tel: ' + (order.customer_phone || 'Non renseigne') + ' | Adresse: ' + (order.customer_address || 'Non renseigne') + '</div></div><div class="order-footer"><div class="order-total">Total: <strong>' + formatPrice(order.total || 0) + ' FCFA</strong></div><div class="order-date">' + formatDate(order.created_at) + '</div></div><div class="order-actions"><button class="order-action-btn secondary" onclick="openStatusModal(\'' + order.id + '\')">Changer statut</button><a href="https://wa.me/' + (order.customer_phone || '').replace(/[^0-9]/g, '') + '" target="_blank" class="order-action-btn primary" style="text-align: center; text-decoration: none;">WhatsApp</a></div></div>';
            });
            list.innerHTML = html;
        }

        function openStatusModal(orderId) {
            selectedOrderId = orderId;
            document.getElementById('statusModal').classList.add('active');
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.remove('active');
            selectedOrderId = null;
        }

        async function updateStatus(newStatus) {
            if (!selectedOrderId) return;
            var result = await supabaseClient.from('teka_orders').update({ status: newStatus }).eq('id', selectedOrderId);
            if (result.error) { alert('Erreur'); console.log('Erreur:', result.error); return; }
            closeStatusModal();
            await loadOrders();
        }

        init();
    </script>

</body>
</html>
