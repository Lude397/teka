<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teka - Conversations</title>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #1A1A2E;
            --light: #FAFAFA;
            --gray: #6B7280;
            --gray-light: #E5E7EB;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --white: #FFFFFF;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            color: var(--secondary);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: var(--white);
            padding: 16px 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            background: var(--light);
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--secondary);
        }

        .header-title { font-size: 18px; font-weight: 600; flex: 1; }

        .header-badge {
            background: var(--primary);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px 16px; }

        .search-filter { display: flex; gap: 12px; margin-bottom: 16px; }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .search-input:focus { border-color: var(--primary); }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            background: var(--white);
            cursor: pointer;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: var(--white);
            border-radius: 20px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            white-space: nowrap;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }

        .tab.active { background: var(--primary); color: var(--white); }
        .tab-count { margin-left: 6px; opacity: 0.7; }

        .conversations-list { display: flex; flex-direction: column; gap: 12px; }

        .conversation-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .conversation-card:hover { transform: translateY(-2px); }
        .conversation-card.unread { border-left: 4px solid var(--primary); }

        .conversation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .conversation-avatar {
            width: 44px;
            height: 44px;
            background: var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .conversation-info { flex: 1; }

        .conversation-visitor {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conversation-visitor .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
        }

        .badge.sale { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge.pending { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge.lost { background: rgba(239, 68, 68, 0.1); color: var(--error); }

        .conversation-meta { font-size: 12px; color: var(--gray); }
        .conversation-time { text-align: right; }
        .conversation-hour { font-size: 12px; color: var(--gray); margin-bottom: 4px; }

        .conversation-unread {
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            margin-left: auto;
        }

        .conversation-preview {
            font-size: 13px;
            color: var(--gray);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .conversation-product {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding: 6px 10px;
            background: var(--light);
            border-radius: 8px;
            font-size: 12px;
        }

        .conversation-product-img {
            width: 24px;
            height: 24px;
            background: var(--gray-light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            overflow: hidden;
        }

        .conversation-product-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light);
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .chat-modal.active { display: flex; }

        .chat-modal-header {
            background: var(--white);
            padding: 16px 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-modal-close {
            width: 40px;
            height: 40px;
            background: var(--light);
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .chat-modal-info { flex: 1; }
        .chat-modal-visitor { font-size: 16px; font-weight: 600; }
        .chat-modal-meta { font-size: 12px; color: var(--gray); }

        .chat-modal-body { flex: 1; overflow-y: auto; padding: 20px; }

        .chat-date-divider { text-align: center; margin: 16px 0; }

        .chat-date-divider span {
            background: var(--gray-light);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            color: var(--gray);
        }

        .chat-message {
            max-width: 85%;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.assistant { align-self: flex-start; }
        .chat-message.user { align-self: flex-end; align-items: flex-end; }

        .chat-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.assistant .chat-bubble {
            background: var(--white);
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow);
        }

        .chat-message.user .chat-bubble {
            background: var(--primary);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }

        .chat-time {
            font-size: 10px;
            color: var(--gray);
            margin-top: 4px;
            padding: 0 4px;
        }

        .chat-modal-footer {
            background: var(--white);
            padding: 16px;
            border-top: 1px solid var(--gray-light);
        }

        .chat-insight {
            background: var(--light);
            border-radius: var(--radius);
            padding: 12px 16px;
            font-size: 13px;
        }

        .chat-insight-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-insight-content { color: var(--gray); }

        .chat-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .chat-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .chat-action-btn.primary { background: var(--primary); color: var(--white); }
        .chat-action-btn.success { background: var(--success); color: var(--white); }
        .chat-action-btn.danger { background: rgba(239, 68, 68, 0.1); color: var(--error); }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-state-text { font-size: 14px; color: var(--gray); }

        .loading { text-align: center; padding: 40px; color: var(--gray); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 10px;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .nav-label { font-weight: 500; }

        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            .conversations-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .chat-modal { left: auto; width: 450px; right: 0; box-shadow: -4px 0 20px rgba(0,0,0,0.1); }
            .bottom-nav { display: none; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <a href="Dashboard.html" class="back-btn">‚Üê</a>
            <span class="header-title">Conversations</span>
            <span class="header-badge" id="totalConversations">0</span>
        </div>
    </header>

    <main class="container">
        <div class="search-filter">
            <input type="text" class="search-input" placeholder="Rechercher..." id="searchInput" oninput="filterConversations()">
            <select class="filter-select" id="filterSelect" onchange="filterConversations()">
                <option value="all">Tous</option>
                <option value="sale">Ventes</option>
                <option value="pending">En cours</option>
                <option value="lost">Perdus</option>
            </select>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="selectTab(this, 'all')">Tous <span class="tab-count" id="countAll">0</span></button>
            <button class="tab" onclick="selectTab(this, 'today')">Aujourd'hui <span class="tab-count" id="countToday">0</span></button>
            <button class="tab" onclick="selectTab(this, 'week')">Cette semaine <span class="tab-count" id="countWeek">0</span></button>
        </div>

        <div class="conversations-list" id="conversationsList">
            <div class="loading">Chargement...</div>
        </div>
    </main>

    <div class="chat-modal" id="chatModal">
        <div class="chat-modal-header">
            <button class="chat-modal-close" onclick="closeChatModal()">‚Üê</button>
            <div class="chat-modal-info">
                <div class="chat-modal-visitor" id="modalVisitor">Visiteur</div>
                <div class="chat-modal-meta" id="modalMeta">Mobile</div>
            </div>
        </div>
        <div class="chat-modal-body" id="chatModalBody"></div>
        <div class="chat-modal-footer">
            <div class="chat-insight">
                <div class="chat-insight-title">Resume</div>
                <div class="chat-insight-content" id="chatInsight">Conversation avec un client.</div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn success" onclick="markAsSale()">Marquer vendu</button>
                <button class="chat-action-btn danger" onclick="markAsLost()">Marquer perdu</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="Dashboard.html" class="nav-item"><div class="nav-icon">üè†</div><div class="nav-label">Accueil</div></a>
        <a href="produits.html" class="nav-item"><div class="nav-icon">üì¶</div><div class="nav-label">Produits</div></a>
        <a href="commande.html" class="nav-item"><div class="nav-icon">üßæ</div><div class="nav-label">Commandes</div></a>
        <a href="conversation.html" class="nav-item active"><div class="nav-icon">üí¨</div><div class="nav-label">Messages</div></a>
        <a href="trafic.html" class="nav-item"><div class="nav-icon">üìä</div><div class="nav-label">Trafic</div></a>
    </nav>

    <script>
        var SUPABASE_URL = 'https://kolwacpvfxdrptldipzj.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvbHdhY3B2ZnhkcnB0bGRpcHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MjYzOTMsImV4cCI6MjA3NzQwMjM5M30.cXXOxBkX9KaddhfY5JoAvMGz-ohxdCoh5iQlHMUGHqE';
        var supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        var vendor = null;
        var conversations = [];
        var products = {};
        var currentConversation = null;
        var currentPeriod = 'all';

        async function init() {
            var vendorData = localStorage.getItem('vendor');
            if (!vendorData) {
                window.location.href = 'login.html';
                return;
            }
            vendor = JSON.parse(vendorData);
            await loadProducts();
            await loadConversations();
        }

        async function loadProducts() {
            var result = await supabaseClient.from('teka_products').select('*').eq('vendor_id', vendor.id);
            if (result.data) {
                result.data.forEach(function(p) { products[p.id] = p; });
            }
        }

        async function loadConversations() {
            var result = await supabaseClient
                .from('teka_conversations')
                .select('*')
                .eq('vendor_id', vendor.id)
                .order('updated_at', { ascending: false });

            if (result.error) {
                console.log('Erreur:', result.error);
                return;
            }

            conversations = result.data || [];
            updateCounts();
            renderConversations();
        }

        function updateCounts() {
            var now = new Date();
            var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            var countToday = conversations.filter(function(c) {
                return new Date(c.created_at) >= today;
            }).length;

            var countWeek = conversations.filter(function(c) {
                return new Date(c.created_at) >= weekAgo;
            }).length;

            document.getElementById('totalConversations').textContent = conversations.length;
            document.getElementById('countAll').textContent = conversations.length;
            document.getElementById('countToday').textContent = countToday;
            document.getElementById('countWeek').textContent = countWeek;
        }

        function formatDate(dateStr) {
            var date = new Date(dateStr);
            var now = new Date();
            var diff = now - date;

            if (diff < 86400000) {
                return "Aujourd'hui, " + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
            if (diff < 172800000) {
                return "Hier, " + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
        }

        function formatTime(dateStr) {
            var date = new Date(dateStr);
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function getStatusLabel(status) {
            var labels = {
                'sale': 'Vendu',
                'pending': 'En cours',
                'lost': 'Perdu'
            };
            return labels[status] || status;
        }

        function getLastMessage(conv) {
            if (!conv.messages || conv.messages.length === 0) return 'Aucun message';
            var lastMsg = conv.messages[conv.messages.length - 1];
            return lastMsg.content || 'Message';
        }

        function renderConversations(filtered) {
            var list = document.getElementById('conversationsList');
            var data = filtered || conversations;

            // Filtrer par periode
            if (currentPeriod !== 'all') {
                var now = new Date();
                var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                var weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

                if (currentPeriod === 'today') {
                    data = data.filter(function(c) { return new Date(c.created_at) >= today; });
                } else if (currentPeriod === 'week') {
                    data = data.filter(function(c) { return new Date(c.created_at) >= weekAgo; });
                }
            }

            if (data.length === 0) {
                list.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-state-icon">üí¨</div><h3 class="empty-state-title">Aucune conversation</h3><p class="empty-state-text">Les conversations avec tes clients apparaitront ici</p></div>';
                return;
            }

            var html = '';
            data.forEach(function(conv) {
                var product = conv.product_id ? products[conv.product_id] : null;
                var productHtml = '';
                
                if (product) {
                    var productImg = product.images && product.images.length > 0 
                        ? '<img src="' + product.images[0] + '" alt="">' 
                        : 'üì∑';
                    productHtml = '<div class="conversation-product"><div class="conversation-product-img">' + productImg + '</div><span>' + product.name + '</span></div>';
                }

                html += '<div class="conversation-card" onclick="openChatModal(\'' + conv.id + '\')">' +
                    '<div class="conversation-header">' +
                        '<div class="conversation-avatar">üë§</div>' +
                        '<div class="conversation-info">' +
                            '<div class="conversation-visitor">' + (conv.visitor_name || 'Visiteur') + ' <span class="badge ' + conv.status + '">' + getStatusLabel(conv.status) + '</span></div>' +
                            '<div class="conversation-meta">' + (conv.visitor_device || 'Appareil inconnu') + '</div>' +
                        '</div>' +
                        '<div class="conversation-time">' +
                            '<div class="conversation-hour">' + formatTime(conv.updated_at) + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="conversation-preview">' + getLastMessage(conv) + '</div>' +
                    productHtml +
                '</div>';
            });

            list.innerHTML = html;
        }

        function filterConversations() {
            var search = document.getElementById('searchInput').value.toLowerCase();
            var status = document.getElementById('filterSelect').value;

            var filtered = conversations;

            if (search) {
                filtered = filtered.filter(function(c) {
                    var visitorMatch = (c.visitor_name || '').toLowerCase().indexOf(search) !== -1;
                    var messageMatch = getLastMessage(c).toLowerCase().indexOf(search) !== -1;
                    var product = c.product_id ? products[c.product_id] : null;
                    var productMatch = product && product.name.toLowerCase().indexOf(search) !== -1;
                    return visitorMatch || messageMatch || productMatch;
                });
            }

            if (status !== 'all') {
                filtered = filtered.filter(function(c) { return c.status === status; });
            }

            renderConversations(filtered);
        }

        function selectTab(btn, period) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            btn.classList.add('active');
            currentPeriod = period;
            renderConversations();
        }

        function openChatModal(id) {
            currentConversation = conversations.find(function(c) { return c.id === id; });
            if (!currentConversation) return;

            document.getElementById('modalVisitor').textContent = currentConversation.visitor_name || 'Visiteur';
            document.getElementById('modalMeta').textContent = (currentConversation.visitor_device || 'Appareil') + ' - ' + formatDate(currentConversation.created_at);

            var summary = currentConversation.summary || 'Conversation avec un client potentiel.';
            document.getElementById('chatInsight').textContent = summary;

            var body = document.getElementById('chatModalBody');
            var messages = currentConversation.messages || [];

            if (messages.length === 0) {
                body.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>Aucun message</p></div>';
            } else {
                var html = '<div class="chat-date-divider"><span>' + formatDate(currentConversation.created_at) + '</span></div>';
                
                messages.forEach(function(msg) {
                    var role = msg.role === 'assistant' ? 'assistant' : 'user';
                    html += '<div class="chat-message ' + role + '">' +
                        '<div class="chat-bubble">' + (msg.content || '') + '</div>' +
                    '</div>';
                });

                body.innerHTML = html;
            }

            document.getElementById('chatModal').classList.add('active');
            body.scrollTop = body.scrollHeight;
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
            currentConversation = null;
        }

        async function markAsSale() {
            if (!currentConversation) return;
            await updateConversationStatus('sale');
        }

        async function markAsLost() {
            if (!currentConversation) return;
            await updateConversationStatus('lost');
        }

        async function updateConversationStatus(newStatus) {
            var result = await supabaseClient
                .from('teka_conversations')
                .update({ status: newStatus })
                .eq('id', currentConversation.id);

            if (result.error) {
                alert('Erreur lors de la mise a jour');
                console.log(result.error);
                return;
            }

            closeChatModal();
            await loadConversations();
        }

        init();
    </script>

</body>
</html>
