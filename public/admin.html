<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teka - Administration</title>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #1A1A2E;
            --light: #FAFAFA;
            --gray: #6B7280;
            --gray-light: #E5E7EB;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --white: #FFFFFF;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--secondary);
            color: var(--secondary);
            line-height: 1.5;
            min-height: 100vh;
        }

        .header {
            background: var(--secondary);
            padding: 20px;
            color: var(--white);
        }

        .header-content { max-width: 1200px; margin: 0 auto; }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .logo { display: flex; align-items: center; gap: 10px; }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .logo-text { font-size: 22px; font-weight: 700; }

        .logo-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            margin-left: 8px;
        }

        .admin-profile { display: flex; align-items: center; gap: 10px; }

        .admin-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .admin-name { font-size: 14px; display: none; }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 16px;
        }

        .stat-card.highlight {
            background: var(--primary);
            grid-column: span 2;
        }

        .stat-icon { font-size: 24px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-card.highlight .stat-value { font-size: 32px; }
        .stat-label { font-size: 12px; opacity: 0.8; }
        .stat-trend { font-size: 12px; margin-top: 6px; opacity: 0.9; }

        .main {
            background: var(--light);
            border-radius: 24px 24px 0 0;
            min-height: calc(100vh - 280px);
            padding: 24px 16px;
            margin-top: 20px;
        }

        .main-content { max-width: 1200px; margin: 0 auto; }

        .section { margin-bottom: 28px; }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title { font-size: 18px; font-weight: 600; color: var(--secondary); }

        .section-link {
            font-size: 13px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            border: none;
            background: var(--white);
            border-radius: 20px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .filter-tab.active {
            background: var(--primary);
            color: var(--white);
        }

        .vendors-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vendor-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .vendor-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .vendor-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 16px;
        }

        .vendor-info { flex: 1; }
        .vendor-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
        .vendor-contact { font-size: 12px; color: var(--gray); }

        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px;
            background: var(--light);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }

        .vendor-stat { text-align: center; }
        .vendor-stat-value { font-size: 14px; font-weight: 700; color: var(--secondary); }
        .vendor-stat-value.commission { color: var(--success); }
        .vendor-stat-label { font-size: 9px; color: var(--gray); }

        .vendor-footer { display: flex; gap: 8px; }

        .vendor-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .vendor-btn.secondary { background: var(--light); color: var(--secondary); }
        .vendor-btn.primary { background: var(--primary); color: var(--white); }
        .vendor-btn.success { background: var(--success); color: var(--white); }

        .activity-list {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .activity-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--gray-light);
        }

        .activity-item:last-child { border-bottom: none; }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .activity-icon.sale { background: rgba(16, 185, 129, 0.1); }
        .activity-icon.vendor { background: rgba(59, 130, 246, 0.1); }

        .activity-info { flex: 1; }
        .activity-text { font-size: 13px; margin-bottom: 2px; }
        .activity-text strong { font-weight: 600; }
        .activity-time { font-size: 11px; color: var(--gray); }
        .activity-amount { font-size: 14px; font-weight: 600; color: var(--success); }

        .summary-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .summary-title { font-size: 14px; color: var(--gray); margin-bottom: 12px; }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .summary-row:last-child { border-bottom: none; }
        .summary-label { font-size: 14px; }
        .summary-value { font-size: 16px; font-weight: 600; }
        .summary-value.highlight { color: var(--primary); font-size: 20px; }
        .summary-value.success { color: var(--success); }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .empty-state-text { font-size: 14px; color: var(--gray); }

        .loading { text-align: center; padding: 40px; color: var(--gray); }

        @media (min-width: 768px) {
            .admin-name { display: block; }
            .stats-overview { grid-template-columns: repeat(4, 1fr); }
            .stat-card.highlight { grid-column: span 1; }
            .vendors-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }

        @media (min-width: 1024px) {
            .vendors-list { grid-template-columns: repeat(2, 1fr); }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-top">
                <div class="logo">
                    <div class="logo-icon">T</div>
                    <span class="logo-text">Teka</span>
                    <span class="logo-badge">Admin</span>
                </div>
                <div class="admin-profile">
                    <span class="admin-name">Sparrow</span>
                    <div class="admin-avatar">SP</div>
                </div>
            </div>

            <div class="stats-overview">
                <div class="stat-card highlight">
                    <div class="stat-icon">ðŸ’°</div>
                    <div class="stat-value" id="totalCommission">0</div>
                    <div class="stat-label">FCFA Commission (3.5%)</div>
                    <div class="stat-trend" id="commissionTrend">Ce mois</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ‘¥</div>
                    <div class="stat-value" id="totalVendors">0</div>
                    <div class="stat-label">Vendeurs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ›’</div>
                    <div class="stat-value" id="totalSales">0</div>
                    <div class="stat-label">Ventes confirmees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ“¦</div>
                    <div class="stat-value" id="totalRevenue">0</div>
                    <div class="stat-label">FCFA Total ventes</div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="main-content">

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Resume des ventes</h2>
                </div>
                <div class="summary-card">
                    <div class="summary-title">Ce mois</div>
                    <div class="summary-row">
                        <span class="summary-label">Total des ventes (confirmees + livrees)</span>
                        <span class="summary-value" id="summaryTotalSales">0 FCFA</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Commission 3.5%</span>
                        <span class="summary-value success" id="summaryCommission">0 FCFA</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Nombre de ventes</span>
                        <span class="summary-value" id="summarySalesCount">0</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Filtrer par periode</h2>
                </div>
                <div class="filter-tabs">
                    <button class="filter-tab" onclick="filterPeriod('today')">Aujourd'hui</button>
                    <button class="filter-tab" onclick="filterPeriod('week')">Cette semaine</button>
                    <button class="filter-tab active" onclick="filterPeriod('month')">Ce mois</button>
                    <button class="filter-tab" onclick="filterPeriod('all')">Tout</button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Vendeurs et leurs ventes</h2>
                </div>
                <div class="vendors-list" id="vendorsList">
                    <div class="loading">Chargement...</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Dernieres ventes confirmees</h2>
                </div>
                <div class="activity-list" id="activityList">
                    <div class="loading">Chargement...</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        var SUPABASE_URL = 'https://kolwacpvfxdrptldipzj.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvbHdhY3B2ZnhkcnB0bGRpcHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MjYzOTMsImV4cCI6MjA3NzQwMjM5M30.cXXOxBkX9KaddhfY5JoAvMGz-ohxdCoh5iQlHMUGHqE';
        var supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        var COMMISSION_RATE = 0.035; // 3.5%
        var vendors = [];
        var allOrders = [];
        var currentPeriod = 'month';

        async function init() {
            await loadVendors();
            await loadAllOrders();
            updateStats();
            renderVendors();
            renderActivity();
        }

        async function loadVendors() {
            try {
                var result = await supabaseClient
                    .from('teka_vendors')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (result.data) {
                    vendors = result.data;
                }
            } catch (error) {
                console.log('Erreur chargement vendeurs:', error);
            }
        }

        async function loadAllOrders() {
            try {
                var result = await supabaseClient
                    .from('teka_orders')
                    .select('*, teka_vendors(shop_name), teka_products(name)')
                    .in('status', ['confirmed', 'delivered'])
                    .order('created_at', { ascending: false });

                if (result.data) {
                    allOrders = result.data;
                }
            } catch (error) {
                console.log('Erreur chargement commandes:', error);
            }
        }

        function getFilteredOrders() {
            var now = new Date();
            var filtered = allOrders;

            if (currentPeriod === 'today') {
                var startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filtered = allOrders.filter(function(o) {
                    return new Date(o.created_at) >= startOfDay;
                });
            } else if (currentPeriod === 'week') {
                var startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                filtered = allOrders.filter(function(o) {
                    return new Date(o.created_at) >= startOfWeek;
                });
            } else if (currentPeriod === 'month') {
                var startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filtered = allOrders.filter(function(o) {
                    return new Date(o.created_at) >= startOfMonth;
                });
            }

            return filtered;
        }

        function updateStats() {
            var filteredOrders = getFilteredOrders();

            // Total vendeurs
            document.getElementById('totalVendors').textContent = vendors.length;

            // Total ventes confirmees
            document.getElementById('totalSales').textContent = filteredOrders.length;

            // Total revenus
            var totalRevenue = 0;
            filteredOrders.forEach(function(o) {
                totalRevenue += o.total || 0;
            });
            document.getElementById('totalRevenue').textContent = formatNumber(totalRevenue);

            // Commission 3.5%
            var commission = Math.round(totalRevenue * COMMISSION_RATE);
            document.getElementById('totalCommission').textContent = formatNumber(commission);

            // Summary
            document.getElementById('summaryTotalSales').textContent = formatNumber(totalRevenue) + ' FCFA';
            document.getElementById('summaryCommission').textContent = formatNumber(commission) + ' FCFA';
            document.getElementById('summarySalesCount').textContent = filteredOrders.length;

            // Period label
            var periodLabel = '';
            if (currentPeriod === 'today') periodLabel = "Aujourd'hui";
            else if (currentPeriod === 'week') periodLabel = 'Cette semaine';
            else if (currentPeriod === 'month') periodLabel = 'Ce mois';
            else periodLabel = 'Tout le temps';
            document.getElementById('commissionTrend').textContent = periodLabel;
        }

        function renderVendors() {
            var list = document.getElementById('vendorsList');
            var filteredOrders = getFilteredOrders();

            if (vendors.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ‘¥</div><div class="empty-state-title">Aucun vendeur</div><div class="empty-state-text">Les vendeurs apparaitront ici</div></div>';
                return;
            }

            var html = '';
            vendors.forEach(function(vendor) {
                var initials = vendor.shop_name.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 2);

                // Calculer les stats pour ce vendeur
                var vendorOrders = filteredOrders.filter(function(o) {
                    return o.vendor_id === vendor.id;
                });

                var vendorRevenue = 0;
                vendorOrders.forEach(function(o) {
                    vendorRevenue += o.total || 0;
                });

                var vendorCommission = Math.round(vendorRevenue * COMMISSION_RATE);

                html += '<div class="vendor-card">' +
                    '<div class="vendor-header">' +
                        '<div class="vendor-avatar">' + initials + '</div>' +
                        '<div class="vendor-info">' +
                            '<div class="vendor-name">' + vendor.shop_name + '</div>' +
                            '<div class="vendor-contact">' + (vendor.phone || vendor.email || '') + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="vendor-stats">' +
                        '<div class="vendor-stat">' +
                            '<div class="vendor-stat-value">' + vendorOrders.length + '</div>' +
                            '<div class="vendor-stat-label">Ventes</div>' +
                        '</div>' +
                        '<div class="vendor-stat">' +
                            '<div class="vendor-stat-value">' + formatNumber(vendorRevenue) + '</div>' +
                            '<div class="vendor-stat-label">FCFA Total</div>' +
                        '</div>' +
                        '<div class="vendor-stat">' +
                            '<div class="vendor-stat-value commission">' + formatNumber(vendorCommission) + '</div>' +
                            '<div class="vendor-stat-label">Ta commission</div>' +
                        '</div>' +
                        '<div class="vendor-stat">' +
                            '<div class="vendor-stat-value">' + formatNumber(vendorRevenue - vendorCommission) + '</div>' +
                            '<div class="vendor-stat-label">Part vendeur</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="vendor-footer">' +
                        '<button class="vendor-btn secondary" onclick="viewShop(\'' + vendor.shop_slug + '\')">' +
                            'Voir boutique' +
                        '</button>' +
                        '<button class="vendor-btn success" onclick="contactVendor(\'' + (vendor.phone || '') + '\')">' +
                            'Contacter' +
                        '</button>' +
                    '</div>' +
                '</div>';
            });

            list.innerHTML = html;
        }

        function renderActivity() {
            var list = document.getElementById('activityList');
            var filteredOrders = getFilteredOrders();

            if (filteredOrders.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ›’</div><div class="empty-state-title">Aucune vente</div><div class="empty-state-text">Les ventes confirmees apparaitront ici</div></div>';
                return;
            }

            var html = '';
            var recentOrders = filteredOrders.slice(0, 10);

            recentOrders.forEach(function(order) {
                var shopName = order.teka_vendors ? order.teka_vendors.shop_name : 'Vendeur';
                var productName = order.teka_products ? order.teka_products.name : 'Produit';
                var commission = Math.round((order.total || 0) * COMMISSION_RATE);

                html += '<div class="activity-item">' +
                    '<div class="activity-icon sale">ðŸ›’</div>' +
                    '<div class="activity-info">' +
                        '<div class="activity-text"><strong>' + shopName + '</strong> - ' + productName + '</div>' +
                        '<div class="activity-time">' + order.customer_name + ' - ' + timeAgo(order.created_at) + '</div>' +
                    '</div>' +
                    '<div class="activity-amount">+' + formatNumber(commission) + ' FCFA</div>' +
                '</div>';
            });

            list.innerHTML = html;
        }

        function filterPeriod(period) {
            currentPeriod = period;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Refresh data
            updateStats();
            renderVendors();
            renderActivity();
        }

        function viewShop(slug) {
            window.open('teka.html?shop=' + slug, '_blank');
        }

        function contactVendor(phone) {
            if (phone) {
                window.open('https://wa.me/' + phone.replace(/\s/g, ''), '_blank');
            } else {
                showToast('Numero non disponible');
            }
        }

        function formatNumber(num) {
            return num.toLocaleString('fr-FR');
        }

        function timeAgo(dateString) {
            var date = new Date(dateString);
            var now = new Date();
            var seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return "A l'instant";
            if (seconds < 3600) return 'Il y a ' + Math.floor(seconds / 60) + ' min';
            if (seconds < 86400) return 'Il y a ' + Math.floor(seconds / 3600) + 'h';
            return 'Il y a ' + Math.floor(seconds / 86400) + 'j';
        }

        function showToast(message) {
            var toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--secondary);color:white;padding:12px 24px;border-radius:8px;font-size:14px;z-index:1000;opacity:0;transition:opacity 0.3s;';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(function() { toast.style.opacity = '0'; }, 2000);
        }

        init();
    </script>

</body>
</html>
